# Metagenome Hybrid Assembly with Cerulean
by Tessa Rhinehart (contact: tessa.rhinehart at gmail dot com)

This notebook walks through the steps used to create a metagenomic assembly using Cerulean software loaded on an 
Amazon Web Services machine image (AMI).


# Getting started
Use the CeruleanTools AMI and attach the Pink Berries data volume. When your instance boots up, mount the volume, e.g. using the following commands to inspect the volumes and mount one to a folder called `~/data`.
```
lsblk
mkdir ~/data
sudo mount /dev/xvdf/ ~/data
```

If you make a snapshot in the right zone (e.g. us-east-1d), you can load and mount the volume directly from your instance:

```
mkdir ~/data

aws ec2 attach-volume --volume-id vol-0bdfad3677d717075 --instance-id i-0a62227ff1d1977bd --device /dev/xvdh

sudo mount /dev/xvdh ~/data
```


## Our reads

The relevant data for metagenomic reads originated from one sample, and were generated by two different sequencing platforms. The long reads are uncorrected PacBio reads, and the short reads are Illumina. Respectively, these files are located at:

```
~/data/metagenomes/sequence_reads/pacbio/corrected.fastq
~/data/metagenomes/sequence_reads/illumina_4pacbio/Lizzy9.fastq
```

The Pacbio file, `corrected.fastq`, is the PacBio data with all contigs stacked onto each other and error-corrected. The non-error-corrected file, `filtered-subreads.fastq`, is located within the same folder. The latter file is the raw material used to create `corrected.fastq`, and consists of PacBio reads (which were originally circular), split into pieces based on adaptor location.

I put copies of these two files into a new folder, `~/hybrid`, so that I don't accidentally change the original files, and so I don't have to reattach the data volume every time I start up the instance.

# Why are all the quality scores "9" on `corrected.fastq`? 

# ABySS: Assemble short-read contigs

First, assemble the short-read contigs in `Lizzy9.fastq`. ABySS will display a lot of output in the terminal if you run the command by itself. Instead, put the output into a new file named `abyss-output.txt` using the `>` symbol so you can look over the output whenever you need.

```
abyss-pe name=short-read k=64 in='Lizzy9.fastq' > abyss-output.txt
```

ABySS's paired-end assembly produces a series of output files. The ones we are concerned are named `short-read-contigs.dot` and `short-read-contigs.fa`.

# What are the extra output files?

# BLASR: Map contigs to long reads

Recall that our long reads are in `corrected.fastq`. We'll map the contigs in `short-read-contigs.fa`.

First use `sawriter` to create a suffix array of `short-read-contigs.fa`: 

```
sawriter short-read-contigs.fa
```

The output is `short-read-contigs.fa.sa`. 

Then use `blasr` to map contigs to the long reads. Blasr takes the following as inputs:

* long reads: `corrected.fastq`
* short read contigs: `short-read-contigs.fa`
* the number of threads: `-nproc 31`
* the output file location: `-out mapping.fasta.m4` 
* the `-header` flag so that the file begins with a helpful header
* and variety of parameters used to make the mapping (values specified in the Cerulean documentation)
```
 blasr corrected.fastq short-read-contigs.fa -minMatch 10 \
     -minPctIdentity 70 -bestn 30 -nCandidates 30 -maxScore -500 \
     -nproc 31 -noSplitSubreads -header\
     -out mapping.fasta.m4
```

If Blasr runs successfully, the mapping will be in `mapping.fasta.m4`.

# Cerulean: Create assembly from mapping


## Clean-up
First, we need to remove the `-header` flag from `mapping.fasta.m4`; otherwise Cerulean will not run. You can do this in your favorite text editor.

We also need to make sure that the relevant files are in the same "base directory" and are all named with the same prefix. For instance I copied these files in the directory `~/hybrid/cerulean` and named them as follows:
```
mapping.fasta.m4    -> metagenome_contigs_mapping.fasta.m4     
short-read-contigs.fa -> metagenome-contigs.fa
short-read-contigs.dot  -> metagenome-contigs.dot
```

Cerulean is run with the following format:lx
```
python src/Cerulean.py --dataname <dataname> --basedir <basedir> \
 --nproc <numthreads>
```
e.g.

```
python ~/Cerulean/src/Cerulean.py --dataname metagenome --basedir ~/hybrid/cerulean-output --nproc 31
```

This will generate two files, `<dataname>_cerulean.fasta` and `<dataname>_cerulean.dot`

